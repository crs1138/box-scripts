#!/usr/bin/env bash

declare="${ECHO_PREFIX:=}"
declare="${GREEN:=}"
declare="${YELLOW:=}"
declare="${RED:=}"
declare="${CYAN:=}"
declare="${WHITE:=}"
declare="${RESET:=}"
declare="${LESS:=}"
declare="${BOX_PROJECT_DIR:=}"
declare="${BOX_PROJECT_FILE:=}"

function deploy_help() {
	cat <<EOF

${YELLOW}WPLib Box ${GREEN}CLI${RESET} ${GREEN}deploy${RESET} usage:

box ${YELLOW}deploy${RESET}	        - Show this help.
box ${YELLOW}deploy ${GREEN}help${RESET}		- Show this help.
box ${YELLOW}deploy ${RESET}[${CYAN}<host>]${RESET}	- Deploys the host as defined in ${GREEN}project.json${RESET}.

EOF
}

function deploy_host() {
    initErrorFile

    local host_id="$1"

    if [ "" == "${host_id}" ]; then
        output "Hostname required when calling 'deploy'"
        exit
    fi

    #
    # @todo Add an error handling get_deploy_host() function and call it here
    #
    json="$(get_deploy_host "${host_id}")"
    exitOnError

    source_url="$(get_source_repo_url)"
    exitOnError

    source_branch="$(get_source_repo_branch "${host_id}")"
    exitOnError


    deploy_url="$(get_raw_deploy_repo_url "${host_id}")"
    exitOnError

    deploy_branch="$(get_raw_deploy_repo_branch "${host_id}")"
    exitOnError

    ensure_no_uncommitted_files

    output
    output "${YELLOW}Preparing to deploy:${RESET}"
    output
    output "\t${CYAN}Source repo:   ${GREEN}${source_url}${RESET}"
    output "\t${CYAN}Source branch: ${GREEN}${source_branch}${RESET}"
    output
    output "\t${CYAN}Deploy repo:   ${GREEN}${deploy_url}${RESET}"
    output "\t${CYAN}Deploy branch: ${GREEN}${deploy_branch}${RESET}"
    output

    echo "Ensuring cached repositories"
    ensure_repo_cached_locally "${source_url}" "${source_branch}"
    ensure_repo_cached_locally "${deploy_url}" "${deploy_branch}"

}

function simplify_pantheon_repo_cache_dir() {
    local repo_url="$1"
    local provider="$(get_raw_project_file | jq -r '.deploy.provider')"
    if [ "pantheon" == "${provider}" ] ; then
        local site_id="$(get_raw_project_file | jq -r '.deploy.site_id')"
        local site_name="$(get_raw_project_file | jq -r '.deploy.site_name')"
        repo_url="${repo_url//\.${site_id}/}"    # Replace guid with URL name
        repo_url="${repo_url//2222\/~\/repository/${site_name}}"    # Replace goggledegook with site_name
    fi
    echo "${repo_url}"
}

function make_cache_dir() {
    cache_dir="$1"
    mkdir --parents "${cache_dir}"
}

function get_raw_repo_cache_dir() {
    declare=${BOX_CACHE_DIR:=}
    local repo_url="$1"
    local path="${repo_url}"
    path="${repo_url#*://}"     # Strip leading protocol; ssh://, https://, http://
    path="${path#*@}"    # Strip leading username, e.g. git@
    path="${path%.git*}"        # Strip trailing .git extension
    path="${path/:/\/}"         # Replace ':' with '/'
    local cache_dir="${BOX_CACHE_DIR}/${path}"
    cache_dir="$(simplify_pantheon_repo_cache_dir "${cache_dir}")"
    echo "${cache_dir}"
}

function get_deploy_host() {
    local host_id="$1"
    json="$(cat "${BOX_PROJECT_FILE}" | jq -r ".deploy.hosts.${host_id}|type")"
    if [ "object" != "${json}" ]; then
        alert ""
        alert "ERROR: ${RED}Your ${GREEN}project.json${RED} file does not define a host named ${YELLOW}\"${GREEN}${host_id}${YELLOW}\"${RED}.${RESET}"
        alert ""
        alert "Please edit your ${GREEN}project.json${RESET} file and add ${YELLOW}\"${GREEN}${host_id}${YELLOW}\"${RESET} as a property of ${GREEN}.deploy.hosts.${RESET}"
        alert ""
        exit 1
    fi
    echo -e "${json}"
}

function get_source_repo_url() {
    local source_repo_url="$(get_raw_source_repo_url)"
    local remote_repo_url="$(get_git_origin_remote_repo_url)"
    if [[ "${source_repo_url}" =~ ^ssh:// ]]; then
        source_repo_url="${source_repo_url#*//}"
    fi
    if [ "${source_repo_url}" != "${remote_repo_url}" ]; then
        alert ""
        alert "${RED}Your source repo and your git remote repo do not match. Cannot deploy.${RESET}"
        alert ""
        alert "\tSource: ${source_repo_url}"
        alert "\tRemote: ${remote_repo_url}"
        alert ""
        alert "Your source repo is found in ${BOX_PROJECT_FILE} as '.source.repository.url.'"
        alert "Your remote is found by running 'git remote -v'. You can set your remote to match your source with:"
        alert ""
        alert "\tgit remote set-url --push origin ${source_repo_url}"
        alert ""
        exit 1
    fi
    echo "${source_repo_url}"
}

function get_source_repo_branch() {
    local host_id="$1"
    local project_branch="$(get_raw_source_host_branch "${host_id}")"
    exitOnError
    local current_branch="$(get_current_git_branch)"
    exitOnError
    if [ "null" == "${project_branch}" ] ; then
        project_branch="n/a"
    fi
    if [ "${current_branch}" != "${project_branch}" ]; then
        alert ""
        alert "${RED}Your current branch does not match the deploy branch for the ${GREEN}${host_id}${RED} host."
        alert "Cannot deploy.${RESET}"
        alert ""
        alert "\t${CYAN}Current Branch: ${GREEN}${current_branch}${RESET}"
        alert "\t${CYAN}Requested Deploy Host: ${GREEN}${host_id}${RESET}"
        alert "\t${CYAN}Deploy branch for host ${RED}${host_id}${RESET}: ${GREEN}${project_branch}${RESET}"
        alert ""
        if [ "n/a" == "${project_branch}" ] ; then
            alert "${RED}Review your project.json file to ensure you have a host ${GREEN}${host_id}${RED} defined in"
            alert "the ${GREEN}.host${RED} section.${RESET}"
        else
            alert "${YELLOW}You can set switch to the project branch for host ${GREEN}${host_id}${YELLOW}, assuming \nall files in your current branch have been committed using:${RESET}"
            alert ""
            alert "\t${GREEN}git checkout ${project_branch}${RESET}"
        fi
        alert ""
        exit 1
    fi
    echo "${current_branch}"
}

function ensure_no_uncommitted_files() {
    local uncommitted_files="$(get_git_uncommitted_files)"
    local file
    if [ "" != "${uncommitted_files}" ]; then
        alert ""
        alert "${RED}Your current branch has uncommitted files. Cannot deploy.${RESET}"
        alert ""
        saveIFS="${IFS}"
        IFS=$'\n'
        for file in $uncommitted_files ; do
            alert "\t${GREEN}${file}${RESET}"
        done
        IFS="${saveIFS}"
        alert ""
        exit 1
    fi
}


################################################################################
CMD="$1"
shift
case $CMD in
    'help')
        ;;

	*|'help')

        if [ "" == "${CMD}" ] ; then
            deploy_help
            exit 1
        fi
        deploy_host "${CMD}"
		;;
esac

